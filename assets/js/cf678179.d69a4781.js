"use strict";(globalThis.webpackChunkthoughtjack_docs_site=globalThis.webpackChunkthoughtjack_docs_site||[]).push([[5636],{3715(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>o,frontMatter:()=>i,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"reference/triggers","title":"Phase Triggers","description":"Trigger types, field matchers, and content matching syntax","source":"@site/docs/reference/triggers.mdx","sourceDirName":"reference","slug":"/reference/triggers","permalink":"/docs/reference/triggers","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"Phase Triggers","sidebar_position":7,"description":"Trigger types, field matchers, and content matching syntax"},"sidebar":"docs","previous":{"title":"Scenario Metadata Schema","permalink":"/docs/reference/scenarios-metadata"},"next":{"title":"Architecture","permalink":"/docs/explanation/architecture"}}');var t=n(4848),d=n(8453);const i={title:"Phase Triggers",sidebar_position:7,description:"Trigger types, field matchers, and content matching syntax"},c="Phase Triggers",l={},h=[{value:"Trigger types",id:"trigger-types",level:2},{value:"Event count",id:"event-count",level:3},{value:"Time-based",id:"time-based",level:3},{value:"Content matching",id:"content-matching",level:3},{value:"Field matchers",id:"field-matchers",level:2},{value:"Exact match",id:"exact-match",level:3},{value:"<code>any_of</code>",id:"any_of",level:3},{value:"<code>contains</code>",id:"contains",level:3},{value:"<code>prefix</code>",id:"prefix",level:3},{value:"<code>suffix</code>",id:"suffix",level:3},{value:"<code>regex</code>",id:"regex",level:3},{value:"Combined pattern",id:"combined-pattern",level:3},{value:"Timeout behavior",id:"timeout-behavior",level:2},{value:"Entry actions",id:"entry-actions",level:2},{value:"Phase diffs",id:"phase-diffs",level:2}];function a(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"phase-triggers",children:"Phase Triggers"})}),"\n",(0,t.jsxs)(s.p,{children:["Phase triggers control when the phase engine advances from one phase to the next. See ",(0,t.jsx)(s.a,{href:"https://github.com/thoughtgate/thoughtjack/blob/main/specs/TJ-SPEC-003_Phase_Engine.md",children:"TJ-SPEC-003"})," for the formal specification."]}),"\n",(0,t.jsx)(s.h2,{id:"trigger-types",children:"Trigger types"}),"\n",(0,t.jsx)(s.h3,{id:"event-count",children:"Event count"}),"\n",(0,t.jsx)(s.p,{children:"Fire after a specific event has occurred a set number of times."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"advance:\n  on: tools/call\n  count: 5\n"})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Field"}),(0,t.jsx)(s.th,{children:"Type"}),(0,t.jsx)(s.th,{children:"Required"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"on"})}),(0,t.jsx)(s.td,{children:"string"}),(0,t.jsx)(s.td,{children:"Yes"}),(0,t.jsx)(s.td,{children:"Event name to count"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"count"})}),(0,t.jsx)(s.td,{children:"integer"}),(0,t.jsx)(s.td,{children:"Yes"}),(0,t.jsx)(s.td,{children:"Threshold count"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"timeout"})}),(0,t.jsx)(s.td,{children:"string"}),(0,t.jsx)(s.td,{children:"No"}),(0,t.jsx)(s.td,{children:"Abort or advance if timeout elapses"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Common events:"})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Event"}),(0,t.jsx)(s.th,{children:"When it fires"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"tools/call"})}),(0,t.jsx)(s.td,{children:"Any tool call"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"tools/list"})}),(0,t.jsx)(s.td,{children:"Tool listing request"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"resources/read"})}),(0,t.jsx)(s.td,{children:"Resource read request"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"resources/list"})}),(0,t.jsx)(s.td,{children:"Resource listing request"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"prompts/get"})}),(0,t.jsx)(s.td,{children:"Prompt get request"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"prompts/list"})}),(0,t.jsx)(s.td,{children:"Prompt listing request"})]})]})]}),"\n",(0,t.jsx)(s.h3,{id:"time-based",children:"Time-based"}),"\n",(0,t.jsx)(s.p,{children:"Fire after a duration elapses from when the phase was entered."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"advance:\n  after: 30s\n"})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Field"}),(0,t.jsx)(s.th,{children:"Type"}),(0,t.jsx)(s.th,{children:"Required"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsx)(s.tbody,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"after"})}),(0,t.jsx)(s.td,{children:"string"}),(0,t.jsx)(s.td,{children:"Yes"}),(0,t.jsx)(s.td,{children:"Duration string"})]})})]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Duration syntax:"})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Suffix"}),(0,t.jsx)(s.th,{children:"Unit"}),(0,t.jsx)(s.th,{children:"Example"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ms"})}),(0,t.jsx)(s.td,{children:"milliseconds"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"500ms"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"s"})}),(0,t.jsx)(s.td,{children:"seconds"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"30s"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"m"})}),(0,t.jsx)(s.td,{children:"minutes"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"5m"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"h"})}),(0,t.jsx)(s.td,{children:"hours"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"1h"})})]})]})]}),"\n",(0,t.jsxs)(s.p,{children:["The phase engine checks time-based triggers at a configurable interval (default: 100ms, controlled by ",(0,t.jsx)(s.code,{children:"THOUGHTJACK_TIMER_INTERVAL_MS"}),")."]}),"\n",(0,t.jsx)(s.h3,{id:"content-matching",children:"Content matching"}),"\n",(0,t.jsx)(s.p,{children:"Fire when an event's payload matches specified field patterns."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'advance:\n  on: tools/call\n  match:\n    args.query:\n      contains: "password"\n'})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Field"}),(0,t.jsx)(s.th,{children:"Type"}),(0,t.jsx)(s.th,{children:"Required"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"on"})}),(0,t.jsx)(s.td,{children:"string"}),(0,t.jsx)(s.td,{children:"Yes"}),(0,t.jsx)(s.td,{children:"Event name to match"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"match"})}),(0,t.jsx)(s.td,{children:"object"}),(0,t.jsx)(s.td,{children:"Yes"}),(0,t.jsx)(s.td,{children:"Field matchers (AND semantics)"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:"Multiple field matchers use AND semantics \u2014 all must match for the trigger to fire."}),"\n",(0,t.jsx)(s.h2,{id:"field-matchers",children:"Field matchers"}),"\n",(0,t.jsx)(s.p,{children:"Field matchers specify conditions on event payload fields."}),"\n",(0,t.jsx)(s.h3,{id:"exact-match",children:"Exact match"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.language: "python"\n'})}),"\n",(0,t.jsx)(s.p,{children:"Matches when the field value is exactly equal to the specified string."}),"\n",(0,t.jsx)(s.h3,{id:"any_of",children:(0,t.jsx)(s.code,{children:"any_of"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.language:\n    any_of: ["python", "javascript", "rust"]\n'})}),"\n",(0,t.jsx)(s.p,{children:"Matches when the field value equals any of the listed values."}),"\n",(0,t.jsx)(s.h3,{id:"contains",children:(0,t.jsx)(s.code,{children:"contains"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.query:\n    contains: "password"\n'})}),"\n",(0,t.jsx)(s.p,{children:"Matches when the field value contains the specified substring (case-sensitive)."}),"\n",(0,t.jsx)(s.h3,{id:"prefix",children:(0,t.jsx)(s.code,{children:"prefix"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.path:\n    prefix: "/etc/"\n'})}),"\n",(0,t.jsx)(s.p,{children:"Matches when the field value starts with the specified string."}),"\n",(0,t.jsx)(s.h3,{id:"suffix",children:(0,t.jsx)(s.code,{children:"suffix"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.file:\n    suffix: ".env"\n'})}),"\n",(0,t.jsx)(s.p,{children:"Matches when the field value ends with the specified string."}),"\n",(0,t.jsx)(s.h3,{id:"regex",children:(0,t.jsx)(s.code,{children:"regex"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.query:\n    regex: "(?i)api[_\\\\s]?key"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Matches when the field value matches the regular expression. Regex patterns use the Rust ",(0,t.jsx)(s.code,{children:"regex"})," crate syntax."]}),"\n",(0,t.jsx)(s.p,{children:"Regex patterns are compiled and cached (up to 256 entries) for performance."}),"\n",(0,t.jsx)(s.h3,{id:"combined-pattern",children:"Combined pattern"}),"\n",(0,t.jsx)(s.p,{children:"A single field matcher can combine multiple pattern conditions (all must match):"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'match:\n  args.path:\n    prefix: "/home/"\n    suffix: ".ssh"\n    contains: "config"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["This matches paths like ",(0,t.jsx)(s.code,{children:"/home/user/.ssh/config"}),"."]}),"\n",(0,t.jsx)(s.h2,{id:"timeout-behavior",children:"Timeout behavior"}),"\n",(0,t.jsx)(s.p,{children:"Event-count triggers support an optional timeout:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"advance:\n  on: tools/call\n  count: 10\n  timeout: 60s\n"})}),"\n",(0,t.jsxs)(s.p,{children:["When the timeout elapses before the count is reached, the ",(0,t.jsx)(s.code,{children:"TimeoutBehavior"})," determines what happens:"]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Behavior"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"advance"})}),(0,t.jsx)(s.td,{children:"Advance to the next phase anyway (default)"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"abort"})}),(0,t.jsx)(s.td,{children:"Abort the phase engine"})]})]})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"advance:\n  on: tools/call\n  count: 10\n  timeout: 60s\n  timeout_behavior: abort    # or: advance (default)\n"})}),"\n",(0,t.jsx)(s.h2,{id:"entry-actions",children:"Entry actions"}),"\n",(0,t.jsxs)(s.p,{children:["When a phase is entered, ",(0,t.jsx)(s.code,{children:"on_enter"})," actions fire in order:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'on_enter:\n  - send_notification: "notifications/tools/list_changed"\n  - send_request:\n      method: "sampling/createMessage"\n      params: {}\n  - log: "Entered exploit phase"\n'})}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Action"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"send_notification"})}),(0,t.jsx)(s.td,{children:"Send an MCP notification to the client"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"send_request"})}),(0,t.jsx)(s.td,{children:"Send an MCP request to the client"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"log"})}),(0,t.jsx)(s.td,{children:"Log a message at INFO level"})]})]})]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Key invariant"}),": The response to the triggering request uses the ",(0,t.jsx)(s.strong,{children:"pre-transition"})," state. Entry actions fire ",(0,t.jsx)(s.strong,{children:"after"})," the response is sent. This ensures the client sees a consistent response before the phase change takes effect."]}),"\n",(0,t.jsx)(s.h2,{id:"phase-diffs",children:"Phase diffs"}),"\n",(0,t.jsx)(s.p,{children:"Each phase can modify the server's tool, resource, and prompt sets:"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Operation"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"add_tools"})}),(0,t.jsx)(s.td,{children:"Add tools to the current set"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"remove_tools"})}),(0,t.jsx)(s.td,{children:"Remove tools by name"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"replace_tools"})}),(0,t.jsx)(s.td,{children:"Replace tools by name (tool must exist)"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"add_resources"})}),(0,t.jsx)(s.td,{children:"Add resources to the current set"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"remove_resources"})}),(0,t.jsx)(s.td,{children:"Remove resources by URI"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"replace_resources"})}),(0,t.jsx)(s.td,{children:"Replace resources by URI"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"add_prompts"})}),(0,t.jsx)(s.td,{children:"Add prompts to the current set"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"remove_prompts"})}),(0,t.jsx)(s.td,{children:"Remove prompts by name"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"replace_prompts"})}),(0,t.jsx)(s.td,{children:"Replace prompts by name"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:"Diff operations are applied atomically when the phase is entered."})]})}function o(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453(e,s,n){n.d(s,{R:()=>i,x:()=>c});var r=n(6540);const t={},d=r.createContext(t);function i(e){const s=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(d.Provider,{value:s},e.children)}}}]);