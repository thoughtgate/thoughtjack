"use strict";(globalThis.webpackChunkthoughtjack_docs_site=globalThis.webpackChunkthoughtjack_docs_site||[]).push([[7362],{3121(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"explanation/architecture","title":"Architecture","description":"System architecture, workspace crates, and module relationships","source":"@site/docs/explanation/architecture.mdx","sourceDirName":"explanation","slug":"/explanation/architecture","permalink":"/thoughtjack/docs/explanation/architecture","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Architecture","sidebar_position":2,"description":"System architecture, workspace crates, and module relationships"},"sidebar":"docs","previous":{"title":"Phase Triggers","permalink":"/thoughtjack/docs/reference/triggers"},"next":{"title":"Phase Engine Design","permalink":"/thoughtjack/docs/explanation/phase-engine"}}');var i=s(4848),t=s(8453);const a={title:"Architecture",sidebar_position:2,description:"System architecture, workspace crates, and module relationships"},c="Architecture",o={},d=[{value:"Workspace crates",id:"workspace-crates",level:2},{value:"Module architecture",id:"module-architecture",level:2},{value:"CLI (<code>cli/</code>)",id:"cli-cli",level:3},{value:"Config (<code>config/</code>)",id:"config-config",level:3},{value:"Phase engine (<code>phase/</code>)",id:"phase-engine-phase",level:3},{value:"Transport (<code>transport/</code>)",id:"transport-transport",level:3},{value:"Dynamic responses (<code>dynamic/</code>)",id:"dynamic-responses-dynamic",level:3},{value:"Generators (<code>generator/</code>)",id:"generators-generator",level:3},{value:"Behavior (<code>behavior/</code>)",id:"behavior-behavior",level:3},{value:"Scenarios (<code>scenarios/</code>)",id:"scenarios-scenarios",level:3},{value:"Observability (<code>observability/</code>)",id:"observability-observability",level:3},{value:"Data flow",id:"data-flow",level:2},{value:"Concurrency model",id:"concurrency-model",level:2},{value:"Key design decisions",id:"key-design-decisions",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,i.jsx)(n.p,{children:"ThoughtJack is a Rust workspace with three crates that together implement an adversarial MCP server for security testing."}),"\n",(0,i.jsx)(n.h2,{id:"workspace-crates",children:"Workspace crates"}),"\n",(0,i.jsx)(n.mermaid,{value:"graph TD\n    TJ[thoughtjack<br/>Binary + Library] --\x3e TC[thoughtjack-core<br/>Shared Types]\n    TD[thoughtjack-docs<br/>Doc Generator] --\x3e TC"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Crate"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtjack"})}),(0,i.jsx)(n.td,{children:"bin + lib"}),(0,i.jsx)(n.td,{children:"Main binary with server runtime, CLI, and all modules"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtjack-core"})}),(0,i.jsx)(n.td,{children:"lib"}),(0,i.jsxs)(n.td,{children:["Configuration schema and shared types (optional ",(0,i.jsx)(n.code,{children:"clap"})," feature)"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"thoughtjack-docs"})}),(0,i.jsx)(n.td,{children:"lib"}),(0,i.jsx)(n.td,{children:"Documentation site generation from scenario metadata"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"thoughtjack-core"})," crate is split out so that ",(0,i.jsx)(n.code,{children:"thoughtjack-docs"})," can read configuration schemas without depending on the full server runtime."]}),"\n",(0,i.jsx)(n.h2,{id:"module-architecture",children:"Module architecture"}),"\n",(0,i.jsx)(n.mermaid,{value:"graph TD\n    CLI[CLI<br/>args.rs, commands/] --\x3e Config[Config Loader<br/>schema, loader, validation]\n    CLI --\x3e Scenarios[Scenarios<br/>Built-in library]\n    Config --\x3e Server[Server Runtime<br/>server.rs]\n    Scenarios --\x3e Server\n    Server --\x3e Phase[Phase Engine<br/>state, triggers, actions]\n    Server --\x3e Transport[Transport<br/>stdio, HTTP/SSE]\n    Server --\x3e Dynamic[Dynamic Responses<br/>handlers, templates, match]\n    Phase --\x3e Behavior[Behavior<br/>delivery, side effects]\n    Config --\x3e Generator[Generators<br/>nested JSON, garbage, ...]\n    Server --\x3e Observability[Observability<br/>logging, metrics, events]"}),"\n",(0,i.jsxs)(n.h3,{id:"cli-cli",children:["CLI (",(0,i.jsx)(n.code,{children:"cli/"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Parses command-line arguments using Clap derive mode. Routes to command handlers for ",(0,i.jsx)(n.code,{children:"server"}),", ",(0,i.jsx)(n.code,{children:"scenarios"}),", ",(0,i.jsx)(n.code,{children:"diagram"}),", ",(0,i.jsx)(n.code,{children:"docs"}),", ",(0,i.jsx)(n.code,{children:"completions"}),", and ",(0,i.jsx)(n.code,{children:"version"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"config-config",children:["Config (",(0,i.jsx)(n.code,{children:"config/"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Loads YAML configuration files, resolves directives (",(0,i.jsx)(n.code,{children:"$include"}),", ",(0,i.jsx)(n.code,{children:"$file"}),", ",(0,i.jsx)(n.code,{children:"$generate"}),", ",(0,i.jsx)(n.code,{children:"$handler"}),"), substitutes environment variables, and validates the result. The schema types live in ",(0,i.jsx)(n.code,{children:"thoughtjack-core"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"phase-engine-phase",children:["Phase engine (",(0,i.jsx)(n.code,{children:"phase/"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Implements the state machine that drives temporal attacks. Key components:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"State"})," \u2014 atomic phase index using ",(0,i.jsx)(n.code,{children:"AtomicU64"})," for lock-free concurrent access"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Triggers"})," \u2014 event-count, time-based, and content-matching trigger evaluation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Actions"})," \u2014 entry actions (notifications, requests, logging) fired on phase transitions"]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"transport-transport",children:["Transport (",(0,i.jsx)(n.code,{children:"transport/"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Abstracts the communication channel between ThoughtJack and MCP clients:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"stdio"})," \u2014 JSON-RPC over stdin/stdout, single connection"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"HTTP"})," \u2014 Axum-based HTTP server with SSE for server-to-client messages, multi-connection"]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"dynamic-responses-dynamic",children:["Dynamic responses (",(0,i.jsx)(n.code,{children:"dynamic/"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"The dynamic response pipeline processes tool calls through several stages:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Match"})," \u2014 evaluate conditional ",(0,i.jsx)(n.code,{children:"when"})," blocks against arguments"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Sequence"})," \u2014 select the next response in a sequence"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Handler"})," \u2014 call external HTTP or command handlers"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Template"})," \u2014 interpolate ",(0,i.jsx)(n.code,{children:"${...}"})," variables and functions"]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"generators-generator",children:["Generators (",(0,i.jsx)(n.code,{children:"generator/"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Factory objects that produce attack payloads lazily at response time. Each generator implements the ",(0,i.jsx)(n.code,{children:"PayloadGenerator"})," trait. Large payloads (> 1 MB) use streaming via ",(0,i.jsx)(n.code,{children:"PayloadStream"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"behavior-behavior",children:["Behavior (",(0,i.jsx)(n.code,{children:"behavior/"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Controls response delivery and side effects:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Delivery"})," \u2014 how bytes are transmitted (slow loris, unbounded line, etc.)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Side effects"})," \u2014 additional actions (notification flood, pipe deadlock, etc.)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Coordinator"})," \u2014 resolves effective behavior from the scoping chain"]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"scenarios-scenarios",children:["Scenarios (",(0,i.jsx)(n.code,{children:"scenarios/"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["10 built-in attack scenarios embedded at compile time via ",(0,i.jsx)(n.code,{children:"include_str!"}),". Supports listing, detail display, fuzzy name matching, and direct execution via ",(0,i.jsx)(n.code,{children:"--scenario"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"observability-observability",children:["Observability (",(0,i.jsx)(n.code,{children:"observability/"}),")"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Logging"})," \u2014 tracing-subscriber with human and JSON formatters"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Metrics"})," \u2014 Prometheus counters, gauges, and histograms (16 metrics)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Events"})," \u2014 structured JSONL event stream for post-run analysis"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"data-flow",children:"Data flow"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Client as MCP Client\n    participant Transport\n    participant Server\n    participant Phase as Phase Engine\n    participant Dynamic as Dynamic Responses\n    participant Behavior\n\n    Client->>Transport: JSON-RPC Request\n    Transport->>Server: Parsed Request\n    Server->>Phase: Evaluate Triggers\n    Phase--\x3e>Server: Phase State (pre-transition)\n    Server->>Dynamic: Resolve Response\n    Dynamic--\x3e>Server: Content Items\n    Server->>Behavior: Deliver Response\n    Behavior->>Transport: Modified Bytes\n    Transport->>Client: JSON-RPC Response\n    Note over Phase: Transition happens AFTER response\n    Phase->>Server: Entry Actions\n    Server->>Transport: Notifications/Requests"}),"\n",(0,i.jsxs)(n.p,{children:["The key invariant is ",(0,i.jsx)(n.strong,{children:"response before transition"}),": the response to a triggering request uses the pre-transition state. Entry actions (notifications, logging) fire after the response is sent."]}),"\n",(0,i.jsx)(n.h2,{id:"concurrency-model",children:"Concurrency model"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Async runtime"}),": Tokio multi-threaded runtime"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Phase state"}),": ",(0,i.jsx)(n.code,{children:"AtomicU64"})," for the phase index, ",(0,i.jsx)(n.code,{children:"DashMap"})," for per-connection state"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Side effects"}),": Spawned as independent Tokio tasks, managed by ",(0,i.jsx)(n.code,{children:"SideEffectManager"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Shutdown"}),": Cooperative via ",(0,i.jsx)(n.code,{children:"CancellationToken"})," (tokio-util)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-design-decisions",children:"Key design decisions"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Lazy generator evaluation"}),": Generators create lightweight factory objects at config load time. Actual payload bytes are produced at response time. This keeps startup fast and memory usage predictable."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Atomic phase state"}),": Using ",(0,i.jsx)(n.code,{children:"AtomicU64"})," instead of a mutex for the phase index enables lock-free reads in the hot path (every request checks the current phase)."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Embedded scenarios"}),": Built-in scenarios are compiled into the binary via ",(0,i.jsx)(n.code,{children:"include_str!"}),". This eliminates runtime file I/O and makes the binary self-contained."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Transport abstraction"}),": The ",(0,i.jsx)(n.code,{children:"Transport"})," trait abstracts stdio and HTTP, so the server runtime doesn't need to know which transport is active. Side effects that are transport-specific (e.g., ",(0,i.jsx)(n.code,{children:"pipe_deadlock"})," for stdio only) check compatibility at runtime."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>c});var r=s(6540);const i={},t=r.createContext(i);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);