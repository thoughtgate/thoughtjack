---
title: Phase Triggers
sidebar_position: 7
description: Trigger types, field matchers, and content matching syntax
---

# Phase Triggers

Phase triggers control when the phase engine advances from one phase to the next. See [TJ-SPEC-003](https://github.com/thoughtgate/thoughtjack/blob/main/specs/TJ-SPEC-003_Phase_Engine.md) for the formal specification.

## Trigger types

### Event count

Fire after a specific event has occurred a set number of times.

```yaml
advance:
  on: tools/call
  count: 5
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `on` | string | Yes | Event name to count |
| `count` | integer | Yes | Threshold count |
| `timeout` | string | No | Abort or advance if timeout elapses |

**Common events:**

| Event | When it fires |
|-------|---------------|
| `tools/call` | Any tool call |
| `tools/list` | Tool listing request |
| `resources/read` | Resource read request |
| `resources/list` | Resource listing request |
| `prompts/get` | Prompt get request |
| `prompts/list` | Prompt listing request |

### Time-based

Fire after a duration elapses from when the phase was entered.

```yaml
advance:
  after: 30s
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `after` | string | Yes | Duration string |

**Duration syntax:**

| Suffix | Unit | Example |
|--------|------|---------|
| `ms` | milliseconds | `500ms` |
| `s` | seconds | `30s` |
| `m` | minutes | `5m` |
| `h` | hours | `1h` |

The phase engine checks time-based triggers at a configurable interval (default: 100ms, controlled by `THOUGHTJACK_TIMER_INTERVAL_MS`).

### Content matching

Fire when an event's payload matches specified field patterns.

```yaml
advance:
  on: tools/call
  match:
    args.query:
      contains: "password"
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `on` | string | Yes | Event name to match |
| `match` | object | Yes | Field matchers (AND semantics) |

Multiple field matchers use AND semantics â€” all must match for the trigger to fire.

## Field matchers

Field matchers specify conditions on event payload fields.

### Exact match

```yaml
match:
  args.language: "python"
```

Matches when the field value is exactly equal to the specified string.

### `any_of`

```yaml
match:
  args.language:
    any_of: ["python", "javascript", "rust"]
```

Matches when the field value equals any of the listed values.

### `contains`

```yaml
match:
  args.query:
    contains: "password"
```

Matches when the field value contains the specified substring (case-sensitive).

### `prefix`

```yaml
match:
  args.path:
    prefix: "/etc/"
```

Matches when the field value starts with the specified string.

### `suffix`

```yaml
match:
  args.file:
    suffix: ".env"
```

Matches when the field value ends with the specified string.

### `regex`

```yaml
match:
  args.query:
    regex: "(?i)api[_\\s]?key"
```

Matches when the field value matches the regular expression. Regex patterns use the Rust `regex` crate syntax.

Regex patterns are compiled and cached (up to 256 entries) for performance.

### Combined pattern

A single field matcher can combine multiple pattern conditions (all must match):

```yaml
match:
  args.path:
    prefix: "/home/"
    suffix: ".ssh"
    contains: "config"
```

This matches paths like `/home/user/.ssh/config`.

## Timeout behavior

Event-count triggers support an optional timeout:

```yaml
advance:
  on: tools/call
  count: 10
  timeout: 60s
```

When the timeout elapses before the count is reached, the `TimeoutBehavior` determines what happens:

| Behavior | Description |
|----------|-------------|
| `advance` | Advance to the next phase anyway (default) |
| `abort` | Abort the phase engine |

```yaml
advance:
  on: tools/call
  count: 10
  timeout: 60s
  timeout_behavior: abort    # or: advance (default)
```

## Entry actions

When a phase is entered, `on_enter` actions fire in order:

```yaml
on_enter:
  - send_notification: "notifications/tools/list_changed"
  - send_request:
      method: "sampling/createMessage"
      params: {}
  - log: "Entered exploit phase"
```

| Action | Description |
|--------|-------------|
| `send_notification` | Send an MCP notification to the client |
| `send_request` | Send an MCP request to the client |
| `log` | Log a message at INFO level |

**Key invariant**: The response to the triggering request uses the **pre-transition** state. Entry actions fire **after** the response is sent. This ensures the client sees a consistent response before the phase change takes effect.

## Phase diffs

Each phase can modify the server's tool, resource, and prompt sets:

| Operation | Description |
|-----------|-------------|
| `add_tools` | Add tools to the current set |
| `remove_tools` | Remove tools by name |
| `replace_tools` | Replace tools by name (tool must exist) |
| `add_resources` | Add resources to the current set |
| `remove_resources` | Remove resources by URI |
| `replace_resources` | Replace resources by URI |
| `add_prompts` | Add prompts to the current set |
| `remove_prompts` | Remove prompts by name |
| `replace_prompts` | Replace prompts by name |

Diff operations are applied atomically when the phase is entered.
